// Test for Entity class
import crack.io FStr, cerr;
import crack.net Poller, POLLIN, POLLOUT;
import crack.strutil StringArray;
import crack.time TimeDelta, seconds;
import crack.runtime exit;
import whip.interpreter ShellInterpreter, RubyInterpreter, INTP_DONE, INTP_READY;
import whip.sockserver InterpreterContainer;

server := InterpreterContainer();
delay := seconds(1);

#~ ShellInterpreter intp = {};
#~ server.add(intp, intp.getFileHandles()[0]);
RubyInterpreter rintp = {};
server.add(rintp, rintp.getFileHandles());

while (rintp.status != INTP_READY) {
  changes := server.processOnce(delay);
  cerr `startup: status = $(rintp.status), changes = $changes\n`;
}

int i = 0;

while (i<10){
  if (rintp.exe(FStr() `puts('hello ruby $i' )\n`) == -1)
    break;
  i++;
  while (rintp.status != INTP_DONE) {
    changes := server.processOnce(delay);
    cerr `$i: status = $(rintp.status), changes = $changes\n`;
  }
}
